// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 *
 * @package    local_mb2builder
 * @license    Commercial https://themeforest.net/licenses
 */
define(["jquery","local_mb2builder/selectors","local_mb2builder/layout","local_mb2builder/helper","local_mb2builder/editor","local_mb2builder/setting_actions"],function(t,a,e,o,i,n){t(a.builder.langspan);var d=function(a,e){e.find("[data-showon_field2]").each(function(){var e=t(this),o=e.attr("data-showon_field2"),i=e.attr("data-showon_value2").toString().split("|"),n=a.closest(".mb2-pb-element").attr("data-"+o),d=t.inArray(n,i);t('[data-showon_field2="'+o+'"]').closest(".form-group").hide(),-1!=d&&t('[data-showon_field2="'+o+'" ][data-showon_value2*="'+n+'"]').closest(".form-group").show()}),e.find("[data-showon_field]").each(function(){var a=t(this),o=a.attr("data-showon_field"),i=a.attr("data-showon_value").toString().split("|"),n=e.find('[data-attrname="'+o+'"]'),d=n.val();"radio"===n.attr("type")&&(d=e.find('[data-attrname="'+o+'"]:checked').val()),t('[data-showon_field="'+o+'"]').closest(".form-group").hide();var r=t.inArray(d,i);-1!=r&&t('[data-showon_field="'+o+'" ][data-showon_value*="'+d+'"]').closest(".form-group").show(),t(document).on("change",'[data-attrname="'+o+'"]',function(){r=t.inArray(t(this).val(),i),t('[data-showon_field="'+o+'"]').closest(".form-group").hide(),-1!=r&&t('[data-showon_field="'+o+'" ][data-showon_value*="'+t(this).val()+'"]').closest(".form-group").show()})})},r=function(t,a){switch(t.attr("data-action")){case"style":return n.actionStyle(t,a);case"color":return n.actionColor(t,a);case"class":return n.actionClass(t,a);case"text":return n.actionText(t,a);case"attribute":return n.actionAttribute(t,a);case"callback":return n.actionCallback(t,a);case"ajax":return n.actionAjax(t,a);case"none":return n.actionNone(t,a);case"data":return n.actionData(t,a);case"setting":return n.actionSetting(t,a)}};return{buildSettings:function(a,n,s){var l=a.closest(".mb2-pb-"+n),c=o.uniqId();e.deactivateSections(),l.addClass("mb2-pb-"+n+"-active"),t("#mb2-pb-modal-settings-"+n).find(".modal-body").empty();var b=t("#tab-settings-"+n+s).clone(!0),m=t("#mb2-pb-modal-settings-"+n).find(".modal-body").append(b);m.find(".nav-tabs a").each(function(){t(this).attr("href",t(this).attr("href")+"_modal")}),m.find(".tab-pane").each(function(){t(this).attr("id",t(this).attr("id")+"_modal")}),m.find(".mb2-pb-radio-el").each(function(){var a=t(this).attr("data-valid")+"_"+c;t(this).find("input").attr("id",a),t(this).find("label").attr("for",a)});var p=m.find(".mb2-pb-editor");p.length>0&&(t(".mb2-pb-editor").removeClass("mb2-pb-active-editor"),t(".mb2-pb-editor-document").removeAttr("contenteditable"),t(".mb2-pb-editor-document").removeClass("mb2-pb-editor-document-active"),t(".mb2-pb-editor-document").attr("id","mb2-pb-editor-document-active"),p.addClass("mb2-pb-active-editor"),m.find(".mb2-pb-editor-document").attr("contenteditable","true"),m.find(".mb2-pb-editor-document").addClass("mb2-pb-editor-document-active"),m.find(".mb2-pb-editor-document").removeAttr("id")),m.find(".mb2-pb-input").each(function(){var a,e=t(this),n=l.attr("data-"+e.attr("data-attrname"));void 0!==(n=o.decodeSpecialHtml(n))&&("radio"===e.attr("type")?(e.prop("checked",!1),e.attr("value")==n&&(e.closest(".mb2-pb-radioform-group").find(".mb2-pb-radio-el").removeClass("checked"),e.prop("checked",!0),e.closest(".mb2-pb-radio-el").addClass("checked"))):e.val(n)),e.hasClass("mb2-pb-editor-input")&&i.initEditor(n,e,l),e.hasClass("mb2-pb-input-type-icon")&&(a=n||e.val())&&(e.closest(".mb2-pb-form-group").find("i").attr("class",a),e.closest(".mb2-pb-form-group").find("i").show()),e.hasClass("mb2-pb-input-type-image")&&(a=n||e.val())&&(e.closest(".mb2-pb-form-group").removeClass("isvideo"),2==o.checkImage(a)&&e.closest(".mb2-pb-form-group").addClass("isvideo"),e.closest(".mb2-pb-form-group").find("img").attr("src",a),e.closest(".mb2-pb-form-group").find("img").show()),r(e,l)});var u=t(".mb2-pb-"+n+"-active").attr("data-elname");t("#mb2-pb-modal-settings-"+n).find(".modal-title").text(u),d(l,m)},saveSettings:function(a){t("#mb2-pb-modal-settings-"+a).find(".mb2-pb-input").each(function(){var e=t(this),n=t(".mb2-pb-"+a+"-active"),d=e.attr("data-attrname"),r=e.val();if(e.hasClass("mb2-pb-editor-input")&&(i.updateFromTextareaBeforeSave(),r=i.getCleanHtml()),"text"===e.attr("data-action")&&(r=o.stripHtml(r,n.attr("data-id")),r=o.replaceText(r)),"radio"===e.attr("type")?e.is(":checked")&&n.attr("data-"+d,r):n.attr("data-"+d,r),"sectionlang"===d||"rowlang"===d){var s="",l="";""!==r&&(s="(",l=")"),n.find(">div>.mb2-pb-language").text(s+r+l)}if("sectionaccess"===d||"rowaccess"===d){var c="";1==r?c='<i class="fa fa-lock"></i>':2==r&&(c='<i class="fa fa-unlock"></i>'),n.find(">div>.mb2-pb-access").html(c)}d===a+"hidden"&&(1==r?n.addClass("hiddenel"):n.removeClass("hiddenel"))}),e.deactivateSections()},canSave:function(e){return t(a.layout.element+"-active").length&&t(a.layout.element+"-active").hasClass("mb2pb-html")?o.validHtml(e.find(".mb2-pb-input-content").val()):1}}});
