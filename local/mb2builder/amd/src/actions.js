// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 *
 * @package    local_mb2builder
 * @copyright  2018 - 2022 Mariusz Boloz (mb2themes.com)
 * @license    Commercial https://themeforest.net/licenses
 */
define(["jquery","core/str","local_mb2builder/selectors","local_mb2builder/layout","local_mb2builder/senddemo","local_mb2builder/helper","local_mb2builder/carousel","local_mb2builder/settings","local_mb2builder/elements","local_mb2builder/parallax","local_mb2builder/media","local_mb2builder/icon","local_mb2builder/export","local_mb2builder/import","local_mb2builder/editor","local_mb2builder/typed"],function(t,e,i,a,s,o,l,n,c,r,u,m,d,b,v,f){return{initActions:function(){var e=t(document),h=t(i.builder.langspan);e.on("click",i.builder.addelement,function(e){e.preventDefault(),o.checkModal(e)&&(t(t(this).attr("data-modal")).modal("show"),t(i.layout.pbcolumn).removeClass("mb2-pb-column-active"),t(this).closest(i.layout.pbcolumn).addClass("mb2-pb-column-active"))}),e.on("click",i.builder.insertelement,function(e){e.preventDefault();var o=t(this).data("id"),n=t(this).data("subelement"),c=t(this).data("subelement_name"),r=a.elementHtml(o,n,c);t(i.builder.activecolumn).find(i.layout.elementcontainer).append(r);var u=r.closest(i.layout.element).find(i.layout.carousel);u.length&&l.carouselInit(u.attr("id")),a.deactivateSections(),a.layoutInit(),s.saveDemo()}),e.on("click",i.toolbar.remove,function(e){e.preventDefault(),confirm(h.data("remove")+": "+t(this).closest(i.layout.element).attr("data-elname")+"?")&&(t(this).closest(i.layout.element).remove(),s.saveDemo())}),e.on("click",i.toolbar.remove_row,function(e){e.preventDefault(),confirm(h.data("remove")+": "+t(this).closest(i.layout.row).attr("data-elname")+"?")&&(t(this).closest(i.layout.row).remove(),s.saveDemo())}),e.on("click",i.toolbar.remove_section,function(e){e.preventDefault(),1!=t(this).closest(i.builder.buildercontainer).find(i.layout.section).length?confirm(h.data("remove")+": "+t(this).closest(i.layout.section).attr("data-elname")+"?")&&(t(this).closest(i.layout.section).remove(),s.saveDemo()):alert(h.data("cannotremove"))}),e.on("click",i.toolbar.remove_subelement,function(e){if(e.preventDefault(),1!=t(this).closest(i.layout.element).find(i.layout.subelement).length){if(confirm(h.data("remove")+": "+t(this).closest(i.layout.subelement).attr("data-elname")+"?")){var a=t(this).closest(i.layout.subelement);if(a.hasClass("mb2-pb-carousel_item")){var o=a.closest(i.layout.element).find(i.layout.carousel);l.carouselDestroy(o.attr("id")),a.closest(i.layout.element).find('.mb2-pb-carousel-item[data-pbid="'+a.attr("data-pbid")+'"]').remove(),l.carouselInit(o.attr("id"))}a.remove(),s.saveDemo()}}else alert(h.data("cannotremove"))}),e.on("click",i.builder.togglewindowsize,function(e){var a=t(this).closest(i.builder.modal);a.hasClass("mb2-pb-modal-wider")?a.removeClass("mb2-pb-modal-wider"):a.addClass("mb2-pb-modal-wider")}),e.on("click",i.settings.settingselement,function(e){if(e.preventDefault(),o.checkModal(e)){t(t(this).attr("data-modal")).modal("show");var a=t(this).closest(i.layout.element).data("id");n.buildSettings(t(this),"element","-"+a)}}),e.on("click",i.settings.settingssubelement,function(e){if(e.preventDefault(),o.checkModal(e)){t(t(this).attr("data-modal")).modal("show");var a=t(this).closest(i.layout.element).data("id");if(t(this).closest(i.layout.subelement).hasClass("mb2-pb-tabs_item")){var s=t(this).closest(".theme-tabs").find(".nav-link"),l=t(this).closest(i.layout.subelement).find(".nav-link");c.tabsActivateItem(s,l)}else if(t(this).closest(i.layout.subelement).hasClass("mb2-pb-accordion_item")){var r=t(this).closest(i.layout.subelement);c.accordionActivateItem(r)}n.buildSettings(t(this),"subelement","-"+a)}}),e.on("click",i.settings.settingsection,function(e){e.preventDefault(),o.checkModal(e)&&(t(t(this).attr("data-modal")).modal("show"),n.buildSettings(t(this),"section",""))}),e.on("click",i.settings.settingsrow,function(e){e.preventDefault(),o.checkModal(e)&&(t(t(this).attr("data-modal")).modal("show"),n.buildSettings(t(this),"row",""))}),e.on("click",i.settings.settingscolumn,function(e){e.preventDefault(),o.checkModal(e)&&(t(t(this).attr("data-modal")).modal("show"),n.buildSettings(t(this),"column",""))}),e.on("click",i.settings.rowtoggle+","+i.settings.layoutrow,function(e){if(e.preventDefault(),o.checkModal(e)){t(t(this).attr("data-modal")).modal("show"),a.deactivateSections(),t(this).closest(i.layout.section).addClass("mb2-pb-section-active");var s=t(i.builder.modallayouts).find(i.builder.modallayout_variant);if(s.removeClass("update"),s.removeClass("current-layout"),t(this).hasClass("layout-row")){t(i.layout.row).removeClass("mb2-pb-row-active"),t(this).closest(i.layout.row).addClass("mb2-pb-row-active"),s.addClass("update");var l=a.currentColumns(t(this));a.rowCurrentClass(l,s)}}}),e.on("click",i.builder.modallayout_variant,function(e){e.preventDefault();var o=t(this).data("row_variant"),n=a.rowHtml(o),c=t(".mb2-pb-section-active").find(".mb2-pb-sortable-rows");if(!t(this).hasClass("current-layout")){if(t(this).hasClass("update")){var r=(c=t(i.layout.row+"-active").find(i.layout.sortable_columns)).find(i.layout.carousel);r.length&&l.carouselDestroy(r.attr("id")),n=a.buildRowColumns(o),c.empty()}c.append(n);var u=c.find(i.layout.carousel);u.length&&l.carouselInit(u.attr("id")),a.deactivateSections(),a.layoutInit(),s.saveDemo(),t(t(this).attr("data-modal")).modal("hide")}}),e.on("click",i.toolbar.duplicate_row,function(e){e.preventDefault();var o=t(this).closest(i.layout.row).clone();t(this).closest(i.layout.container_rows).append(o),c.runElements(o),a.layoutInit(),s.saveDemo()}),e.on("click",i.toolbar.duplicate_section,function(e){e.preventDefault();var o=t(this).closest(i.layout.section).clone();t(this).closest(i.layout.container_sections).append(o),c.runElements(o),a.layoutInit(),s.saveDemo()}),e.on("click",i.toolbar.duplicate_element,function(e){e.preventDefault();var o=t(this).closest(i.layout.element).clone();t(this).closest(i.layout.elementcontainer).append(o),c.runElements(o),a.layoutInit(),s.saveDemo()}),e.on("click",i.toolbar.duplicate_subelement,function(e){e.preventDefault();var n=t(this).closest(i.layout.subelement).clone();if(t(this).closest(i.layout.subelement).hasClass("mb2-pb-accordion_item")){var r="accordion_item"+o.uniqId();n.find('[data-toggle="collapse"]').attr("data-target","#"+r),n.find('[data-toggle="collapse"]').attr("aria-controls","#"+r),n.find(".collapse").removeClass("show"),n.find(".collapse").attr("id",r)}t(this).closest(i.layout.subelement).hasClass("mb2-pb-tabs_item")&&c.tabsDuplicateItem(t(this),n),t(this).closest(i.layout.subelement).hasClass("mb2-pb-carousel_item")&&l.carouselDuplicateItem(t(this),n),t(this).closest(i.layout.container_subelements).append(n),a.layoutInit(),s.saveDemo()}),e.on("click",i.settings.save_element+","+i.settings.save_subelement+","+i.settings.save_section+","+i.settings.save_row+","+i.settings.save_column,function(e){var a=t(this).closest(i.builder.modal),o=a.attr("data-type");if(n.canSave(a)){switch(o){case"settings-section":n.saveSettings("section");break;case"settings-row":n.saveSettings("row");break;case"settings-element":n.saveSettings("element");break;case"settings-column":n.saveSettings("column");break;case"settings-subelement":n.saveSettings("subelement")}s.saveDemo(),t(t(this).attr("data-modal")).modal("hide")}}),e.on("click",i.settings.image_add,function(e){e.preventDefault(),t('input[name="mb2_pb_input_image_url"]').removeClass("mb2_pb_input_image_url_active"),t(this).closest(i.settings.form_group).find('input[name="mb2_pb_input_image_url"]').addClass("mb2_pb_input_image_url_active"),t(".mb2-pb-search-image").val(""),t(".mb2-pb-search-image").trigger("keyup")}),e.on("click",i.settings.image_insert,function(e){e.preventDefault();var a=t(i.layout.row+"-active"),s=a.hasClass("parallax1");s&&r.parallaxDestroy(a);var l=t(this).data("imgurl"),n=t(i.settings.image_activeinput);n.val(l),n.closest(i.settings.form_group).removeClass("isvideo"),2==o.checkImage(l)&&n.closest(i.settings.form_group).addClass("isvideo");var c=n.closest(i.settings.form_group).find(i.settings.image_preview);c.show(),c.attr("src",l);var m=n.closest(i.builder.modal).data("type");u.imageAction(l,n,m),s&&r.parallaxInit(a)}),e.on("click",i.settings.image_remove,function(e){e.preventDefault();var a=t(i.layout.row+"-active");a.hasClass("parallax1")&&r.parallaxDestroy(a),t(this).closest(i.settings.form_group).removeClass("isvideo");var s=t(this).closest(i.settings.form_group).find('input[name="mb2_pb_input_image_url"]');s.val("");var o=t(this).closest(i.settings.form_group).find(i.settings.image_preview);o.hide(),o.attr("src","");var l=s.closest(i.builder.modal).data("type");u.imageRemoveAction(s,l)}),t(i.builder.search_image).each(function(){t(this).on("keyup",function(){var e=t(this).val().toLowerCase();t(this).closest(".modal-body").find(i.settings.image_insert).each(function(){t(this).filter('[data-imgname*="'+e+'"]').length>0||0==e.length?t(this).closest(i.settings.image_toinsert).show():t(this).closest(i.settings.image_toinsert).hide()})})}),e.on("click",i.settings.media_apply,function(e){e.preventDefault(),u.applyFileManager(t(this))}),e.on("click",i.settings.media_remove,function(e){e.preventDefault(),u.removeFileManager(t(this))}),e.on("click",i.settings.icon_select,function(e){t(i.settings.icon_input).removeClass("active"),t(this).closest(i.settings.form_group).find(i.settings.icon_input).addClass("active")}),e.on("click",i.settings.icon_choose,function(e){e.preventDefault();var a=t(this).data("iconname"),s=t(i.settings.icon_input+".active"),o=s.closest(i.builder.modal).data("type");s.val(a),t(i.settings.icon_input+".active").closest(i.settings.form_group).find("i").show(),t(i.settings.icon_input+".active").closest(i.settings.form_group).find("i").attr("class",a),t(i.builder.search_icon).val(""),t(i.builder.search_icon).trigger("keyup"),m.iconAction(a,s,o)}),e.on("click",i.settings.icon_remove,function(e){e.preventDefault();var a=t(this).closest(".mb2-pb-form-group").find(".mb2-pb-input-type-icon");a.attr("data-default")?(a.val(a.attr("data-default")),t(this).closest(i.settings.form_group).find("i").attr("class",a.attr("data-default"))):(a.val(""),t(this).closest(i.settings.form_group).find("i").attr("class",""),t(this).closest(i.settings.form_group).find("i").hide());var s=a.closest(i.builder.modal).data("type");m.iconRemoveAction(a,s)}),t(i.builder.search_icon).each(function(){t(this).on("keyup",function(){var e=t(this).val().toLowerCase();t(this).closest(".tab-pane").find(i.settings.icon_choose).each(function(){t(this).filter('[data-iconname*="'+e+'"]').length>0||0==e.length?t(this).show():t(this).hide()})})}),e.on("click",i.builder.importexportbtn,function(e){o.checkModal(e)&&t(t(this).attr("data-modal")).modal("show")}),e.on("submit",i.builder.form_savelayout,function(e){e.preventDefault(),d.savelayout(t(this))}),e.on("submit",i.builder.form_importlayout,function(e){e.preventDefault(),b.customLayout(t(this))}),e.on("click",i.builder.import_partbtn,function(e){e.preventDefault(),b.predefinedPart(t(this))}),e.on("click",i.elements.animnum_runbtn,function(e){e.preventDefault();var a=t(i.elements.animnum+""+i.layout.element+"-active");a.find(i.elements.animnum_item_number).text("0"),c.animnumInit(a,!0)}),e.on("click",i.elements.heading_type_refresh,function(e){var a=t(i.elements.heading+""+i.layout.element+"-active").find(".heading").attr("id");f.beforeTypedInit(a),f.typedInit(a)}),e.on("click",i.settings.cancel+","+i.builder.modal+" .close",function(t){o.reload()}),e.on("click",i.builder.modalelements+" .close",function(t){a.deactivateSections()}),e.on("click",i.builder.editor_active+" button",function(e){e.preventDefault(),v.buttonActions(t(this))}),e.on("change",i.builder.editor_active+' select[data-action="formatBlock"]',function(e){v.formatBlock(t(this))}),e.on("click",i.builder.editor_active+" .mbp-pb-editor-htmlmode",function(e){v.toggleMode(t(this))}),e.on("click",i.builder.editor_active+" "+i.toolbar.editor_image,function(e){v.toggleHelper(t(this))}),e.on("click",i.builder.editor_document+" a",function(e){t(i.builder.editor_document).find("a").removeClass("active"),t(this).addClass("active")}),e.on("click",i.builder.editor_active+" "+i.toolbar.editor_link,function(e){v.toggleHelper(t(this)),v.setLinkForm(t(this))}),e.on("click",i.settings.editor_link_save,function(e){v.linkSave(t(this))}),e.on("click",i.settings.editor_link_cancel,function(e){v.linkCancel(t(this))}),e.on("click",i.settings.editor_image_save,function(e){v.imageSave(t(this))}),e.on("click",i.builder.editor_document+" img",function(e){v.imageActive(t(this))}),e.on("click",i.settings.editor_image_remove,function(e){v.imageRemove(t(this))}),e.on("click",i.settings.editor_image_cancel,function(e){v.imageCancel(t(this))}),e.on("submit",i.elements.login+" form",function(t){t.preventDefault()}),e.on("submit",i.elements.search+" form",function(t){t.preventDefault()}),e.on("click",i.toolbar.items,function(e){e.preventDefault(),t(this).closest(i.layout.element).find(i.layout.container_subelements).slideToggle(250)}),e.on("click",i.builder.preventclick,function(t){t.preventDefault()}),e.on("click",i.builder.collapsedgroup_header,function(e){var a=t(this).closest(i.builder.collapsedgroup);a.find(i.builder.collapsedgroup_content);a.hasClass("open")?a.removeClass("open"):(t(i.builder.collapsedgroup).removeClass("open"),a.addClass("open"))})}}});
