// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 *
 * @package    local_mb2builder
 * @license    Commercial https://themeforest.net/licenses
 */
define(["jquery","local_mb2builder/selectors","local_mb2builder/helper"],function(e,t,i){e(t.builder.langspan);var n=function(i){i||(i=r());var n=e(".mb2-pb-active-editor").siblings(t.builder.editor_document);n.empty(),n.append(d(i)),""===n.html()&&n.html(r())},r=function(){return"<p><br></p>"},l=function(n,r,l,d){var o=n.closest(t.settings.form_group).find(".mb2-pb-editor-document-active"),s=r;r.hasClass("mb2-pb-tabs_item")&&(r=r.closest(".mb2-pb-tabs")),l&&(o=n),n.attr("data-selector")&&(s=r.find(n.attr("data-selector"))),d?o.on("input",function(){l?(s.html(i.replaceText(e(this).val())),r.attr("data-"+n.attr("data-attrname"),e(this).val())):(s.html(a()),r.attr("data-"+n.attr("data-attrname"),a()))}):s.html(a())},a=function(){var n=e(".mb2-pb-active-editor").siblings(t.builder.editor_document).clone();n.find('[id^="yui"]').each(function(){e(this).removeAttr("id")}),n.find('*[class=""]').each(function(){e(this).removeAttr("class")});var r=n.html();return"<p></p>"===(r=i.replaceText(r))||"<p><br></p>"===r?"":r},d=function(e){return o(e,[{regex:/<style[^>]*>[\s\S]*?<\/style>/gi,replace:""},{regex:/<!--(?![\s\S]*?-->)/gi,replace:""},{regex:/<\/?(?:title|meta|style|st\d|head|font|html|body|link)[^>]*?>/gi,replace:""}])},o=function(e,t){var i=0;for(i=0;i<t.length;i++)e=e.replace(t[i].regex,t[i].replace);return e},s=function(){e(t.builder.editor_active).siblings(t.builder.editor_document).focus()},u=function(){e('input[name="mb2_pb_input_link_url"]').val(""),e('input[name="mb2_pb_editor_link_target"]').checked=!1,e(t.builder.editor_document).find("a").removeClass("active")},m=function(e,t,i){s();var n=current_selection_range;i.length?(i.attr("href",e),t.prop("checked")?i.attr("target","_blank"):i.removeAttr("target")):(link=document.createElement("a"),n.collapsed?link.appendChild(document.createTextNode(e)):link.appendChild(document.createTextNode(n.toString())),link.setAttribute("href",e),t.prop("checked")?link.setAttribute("target","_blank"):link.removeAttribute("target"),n.deleteContents(),n.insertNode(link))};return{initEditor:function(e,t,i){document.queryCommandSupported("DefaultParagraphSeparator")&&document.execCommand("DefaultParagraphSeparator",!1,"p"),n(e),l(t,i,!1,!0)},updateFromTextareaBeforeSave:function(){var i=e(".mb2-pb-active-editor").siblings(t.builder.editor_document).closest(".form-group").find(".mb2-pb-editor-input");i.hasClass("editing")&&n(i.val())},getCleanHtml:a,buttonActions:function(e){s();var t=e,i=t.data("action"),n=!1,r=null;t.data("show-default-ui")&&(n=t.data("show-default-ui")),t.data("value-args")&&(r=t.data("value-args")),document.execCommand(i,n,r)},formatBlock:function(e){e.val()&&document.execCommand("formatBlock",!1,"<"+e.val()+">")},toggleMode:function(i){var r=i.closest(".form-group"),d=r.find(t.builder.editor_input),o=e(t.layout.element+"-active");e(t.layout.subelement+"-active").length&&(o=e(t.layout.subelement+"-active")),d.hasClass("editing")?(n(d.val()),d.removeClass("editing"),r.removeClass("source"),l(d,o,!1,!0)):(d.val(""),d.addClass("editing"),r.addClass("source"),textarea_value=a(),d.val(textarea_value),l(d,o,!0,!0))},toggleHelper:function(e){var i=e.closest(t.builder.editor_active).find(t.builder.editor_helper);e.hasClass("mbp-pb-editor-helper-link")?(i.find(".element-image").hide(),i.find(".element-link").slideToggle(250)):(i.find(".element-link").hide(),i.find(".element-image").slideToggle(250))},setLinkForm:function(e){var i=e.closest(t.builder.editor_active).find(t.builder.editor_helper);current_selection=window.getSelection(),current_selection_range=current_selection.getRangeAt(0);var n=e.closest(t.settings.form_group).find(t.builder.editor_document).find("a.active");n.length&&(i.find('input[name="mb2_pb_input_link_url"]').val(n.attr("href")),"_blank"===n.attr("target")&&(i.find('input[name="mb2_pb_editor_link_target"]').checked=!0))},linkSave:function(e){var i=e.closest(t.builder.editor_helper+"-element"),n=i.find('input[name="mb2_pb_input_link_url"]').val(),r=i.find('input[name="mb2_pb_editor_link_target"]'),l=e.closest(t.settings.form_group).find(t.builder.editor_document).find("a.active");e.closest(t.builder.editor_helper+"-element").slideUp(250),n&&(m(n,r,l),u())},linkCancel:function(e){e.closest(t.builder.editor_helper+"-element").slideUp(250),u()},imageSave:function(i){s();var n=i.closest(t.builder.editor_helper+"-element"),r=n.find('input[name="mb2_pb_input_image_url"]'),a=r.val();if(i.closest(t.builder.editor_helper+"-element").slideUp(250),a){var d=i.closest(t.settings.form_group).find(t.builder.editor_document).find("img.active");0==d.length&&document.execCommand("insertimage",!1,a);var o=i.closest(t.settings.form_group).find(t.builder.editor_document).find('img[src="'+a+'"]');d.length&&(o=i.closest(t.settings.form_group).find(t.builder.editor_document).find("img.active"));var u=n.find('input[name="mb2_pb_editor_image_width"]'),m=n.find('input[name="mb2_pb_editor_image_desc"]'),c=n.find('select[name="mb2_pb_editor_image_align"]');r.val()&&o.attr("src",r.val()),u.val()&&o.attr("width",u.val()),m.val()&&o.attr("alt",m.val()),c.val()&&o.attr("class",c.val()),i.closest(t.settings.form_group).find(t.builder.editor_document).find("img").removeClass("active"),i.closest(t.builder.editor_helper).find(t.settings.image_preview).hide(),e(t.builder.editor_helper+"-element").find("input").val(""),e(t.builder.editor_helper+"-element").find("select").val("img-align-none");var p=e(t.layout.element+"-active");0==p.length&&(p=e(t.layout.subelement+"-active"));var _=i.closest(t.settings.form_group).find(t.builder.editor_input);l(_,p,!1,!1)}},imageActive:function(i){e(t.builder.editor_document).find("img").removeClass("active");var n=i.closest(t.settings.form_group).find(t.builder.editor_helper),r=i,l=i.closest(t.settings.form_group).find(t.builder.editor_helper+"-element"),a=l.find(t.settings.image_preview);a.show(),a.attr("src",r.attr("src"));var d=l.find('input[name="mb2_pb_input_image_url"]'),o=l.find('input[name="mb2_pb_editor_image_width"]'),s=l.find('input[name="mb2_pb_editor_image_desc"]'),u=l.find('select[name="mb2_pb_editor_image_align"]');d.val(r.attr("src")),o.val(r.attr("width")),s.val(r.attr("alt")),u.val(r.attr("class")),i.addClass("active"),n.find(".element-image").slideDown(250)},imageRemove:function(i){s();var n=i.closest(t.builder.editor_helper+"-element"),r=n.find('input[name="mb2_pb_input_image_url"]').val();i.closest(t.builder.editor_helper+"-element").slideUp(250),i.closest(t.settings.form_group).find(t.builder.editor_document).find('img[src="'+r+'"]').remove(),i.closest(t.builder.editor_helper).find(t.settings.image_preview).hide(),n.find("input").val(""),n.find("select").val("img-align-none");var a=e(t.layout.element+"-active");0==a.length&&(a=e(t.layout.subelement+"-active"));var d=i.closest(t.settings.form_group).find(t.builder.editor_input);l(d,a,!1,!1)},imageCancel:function(i){e(t.builder.editor_helper+"-element").find("input").val(""),e(t.builder.editor_helper+"-element").find("select").val("img-align-none"),i.closest(t.builder.editor_helper).find(t.settings.image_preview).hide(),i.closest(t.builder.editor_helper).find(".element-image").slideUp(250),i.closest(t.settings.form_group).find(t.builder.editor_document).find("img").removeClass("active")}}});
